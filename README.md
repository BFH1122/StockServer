# StockServer
整个服务端主要分为：
	1：TCP服务模块
		监听服务端特定端口，当有新用户（socket）连接时，为新用户分配单独的服务线程（服务类程序在base 中deal_with，服务程序需要继承base类并重写该方法），可以实现一对多服务模式（一个服务器多个客户机）。服务线程传递的参数为MySocket对象（下面有解析），主要负责接收用户传递的TCP消息，进行服务数据的反馈。服务线程不采用线程池管理。


	2：UDP服务模块
		TCP服务模块采用注册的方式同时管理对应UDP服务模块，在TCP程序启动过程中，会初始化UDP服务，在此服务中，UDP服务模块主要负责实时数据的接收，处理（使用线程池），转发。UDP服务模块通过维护MySocket队列来保存已连入客户端地址信息（在TCP连接建立的开始加入UDP管理，TCP断开时从管理队列中移除），方便采用UDP广播实时数据（UDP实时性较高的特性）。注：转发的过程中主要使用 MySocket 队列中连接对象维护的地址信息（客户端在启动TCP服务时反向监听对应端口的UDP消息）。


	3：数据库管理模块
		主要维护 增 删 改 查 语句的执行，管理对象的建立，关闭。

	4：任务线程池管理模块
		线程池使用原则：
			设线程创建时间 t1，线程执行时间 t2，线程销毁时间 t3 当 t1 + t2 > t3 时使用线程池。
			在本服务中，线程主要分为：
				
				用户服务线程：主要负责监听用户TCP消息，此线程需要保证在TCP连接的整个过程中时刻运行，多数处于阻塞的状态。不选择采用线程池服务。

				UDP服务线程：在UDP服务模块启动之后，会立即创建一个接收消息线程。为了防止漏包事件的发生，此线程只负责接收消息，然后传递给子线程完成数据解析与转发的工作。由于每传来一个包就会产生一个线程，数量庞大，不使用线程池会使CPU满载，采用线程池之后CPU占用率 0-6%。

				额外线程：用户第一次连接时，需要将当前服务器端的最新报表数据全部发送，**为不阻塞线程** 发送任务采用线程池管理，任务类是 FUDPTask.cpp 。


	5：其他工具类模块
		声明为静态函数。


	注意：框架服务类中不会管理用户程序内存，添加服务类时需要用户自己管理数据内存。目前，程序占用内存比较稳定，不会因为时间		增长而导致内存增加（新客户端连入时，会有响应内存的增加，属于正常现象）


源文件目录说明：
	DataHelper : 解析UDP数据（实时数据）

	DBHelper : 数据库管理类   连接 mysql 需要配置 mysql 环境 （.dll文件）

	JSONHelper :  jsoncpp 工具类  环境配置（当前采用第二种） ：https://www.cnblogs.com/liaocheng/p/4243731.html
 
	TimeHelper : 时间转化工具类  ，UNIX 转 xxxx-xx-xx xx:xx:xx   xxxx-xx-xx xx:xx:xx 转 UNIX

	NetHelper:
		TCPHelper : 负责建立服务端的TCP监听程序，为新的客户端连入分配新的服务线程

		UDPHelper : UDP服务启动，负责数据的解析，转发。 管理连入服务器的SOCKET队列，进行消息的广播（sendTcp函数完成广播的工作，借助于TCP的客户端地址，实则通过UDP转发）。在此类中对于每个UDP报文段的解析与转发过程利用子线程完成，通过线程池进行管理。

		MySocket : TCP通信协议的封装类，完成对通信协议内数据的提取与封装的任务。

		Base : 处理用户请求服务线程的服务类，没有具体实现，用户需要自定义服务类并继承base , 入口是deal_with函数，传递的参数为Mysocket对象。

		customer : 本服务定义的服务程序，主要解析用户命令并响应。

	Task : 线程池中任务类
		CTask : 是线程池任务基类 ，定义setData(void *) -- 设置传递的参数  getData----获取任务参数  虚函数taskProc 是任务入口，由线程池调用，需要继承的子类实现此方法。


		FUDPTask : 负责新的客户端连入时，将服务器端最新的报表数据同时发送给客户端（多次发送，目标只是新连入客户端）。

		UDPTask : 负责UDP报文的解析，处理，存储（mysql）,转发（广播模式）。------ 因为每一个UDP报文对应一个UDPTask对象，所以数量极多，重写时一定释放内存，否则内存持续增长。


	Thread :  线程池
		使用线程池只需要了解 MyThreadPool：
			
			addTask(CTask *) : 向线程池中添加任务类。由线程池在合适的时机分配线程进行任务的执行。

			MyThreadPool(int num) : 线程池初始化函数。num值代表线程池创建的线程数量。


		**线程池采用 队列  数据结构进行任务管理，可以保证先进任务先得到线程分配，但是执行时间长短不知。